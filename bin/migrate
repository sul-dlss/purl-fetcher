#!/usr/bin/env ruby
# frozen_string_literal: true

# Migrates purl and stacks to ocfl.

require_relative '../config/environment'
require 'optparse'

options = { limit: nil, overwrite: false }

parser = OptionParser.new do |option_parser|
  option_parser.banner = 'Usage: bin/migrate [options]'
  option_parser.on('-o', '--overwrite', 'Overwrite existing.')
  option_parser.on('-lLIMIT', '--limit LIMIT', Integer, 'Only process some purls, otherwise all.')
  option_parser.on('-h', '--help', 'Displays help.') do
    puts option_parser
    exit
  end
end

parser.parse!(into: options)

purls = options[:limit] ? Purl.limit(options[:limit]) : Purl.all
count = purls.count

purls.select(:id, :druid).find_each(batch_size: 1000).with_index do |purl, index|
  puts "#{purl.druid} (#{index + 1}/#{count})"
  OcflMigrator.migrate(druid: purl.druid, overwrite: options[:overwrite])
end
